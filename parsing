#!/bin/bash

# Detectron2 Server Environment Setup Script
# For running on rorqual server to avoid local CPU crashes

set -e

echo "=== Detectron2 Server Environment Setup ==="

# Update system packages
echo "Updating system packages..."
sudo apt-get update
sudo apt-get install -y python3-pip python3-venv git wget curl

# Create virtual environment
echo "Creating Python virtual environment..."
python3 -m venv detectron2_env
source detectron2_env/bin/activate

# Upgrade pip
pip install --upgrade pip

# Install PyTorch (CPU version for server - adjust if GPU available)
echo "Installing PyTorch..."
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# Install other dependencies
echo "Installing dependencies..."
pip install opencv-python pillow numpy matplotlib

# Install Detectron2
echo "Installing Detectron2..."
pip install 'git+https://github.com/facebookresearch/detectron2.git'

# Install gdown for Google Drive downloads
echo "Installing gdown..."
pip install gdown

# Install additional useful packages
pip install requests tqdm pandas

echo "=== Setup Complete ==="
echo "Activate environment with: source detectron2_env/bin/activate"
echo "Deactivate with: deactivate"

# Test installation
echo "Testing Detectron2 installation..."
python3 -c "import detectron2; print('Detectron2 version:', detectron2.__version__)"
python3 -c "import gdown; print('gdown installed successfully')"

echo "Environment ready for use!"